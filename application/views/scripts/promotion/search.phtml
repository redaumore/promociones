<?php
    $messages = $this->errorMessage;
    $this->form->setAction($this->url());
    $form = $this->form;
      /*echo $this->headLink()->appendStylesheet($this->baseUrl().'/skins/default/css/jquery-ui-1.8.23.custom.css')
            ->appendStylesheet($this->baseUrl().'/skins/default/css/ui.jqgrid.css');
      echo $this->headScript()->appendScript($this->baseUrl().'/scripts/jquery-1.8.0.min.js')
            ->appendScript($this->baseUrl().'/scripts/jquery-ui-1.8.23.custom.min.js')
            ->appendScript($this->baseUrl().'scripts/grid.locale-es.js')
            ->appendScript($this->baseUrl().'/scripts/jquery.jqGrid.min.js');
      */
?>
<script type="text/javascript" src="/scripts/prototype.js"></script>
<script type="text/javascript">
function loadCities()
{
        var selectedValue = document.getElementById('province').options[document.getElementById('province').selectedIndex].value;
        var myAjax = new Ajax.Request(
        "<?=$this->url(array('controller'=>'backendAjax','action'=>'getCities'))?>",
            {
                method:'get',
                parameters: {province_id: selectedValue},
                onSuccess: FillForm
        });
 
}

function loadProvinces()
{       var myAjax = new Ajax.Request(
        "<?=$this->url(array('controller'=>'backendAjax','action'=>'getProvinces'))?>",
            {
                method:'get',
                onSuccess: FillFormProvinces
        });
        
 
}

function FillForm(data)
{       var select = document.getElementById("city");
        select.options.length = 0;
        var cities = eval('(' + data.responseText + ')');
        for (var i = 0; i < cities.length; i++){
            select.options[select.options.length] = new Option(cities[i].name, cities[i].city_id); 
        } 
}

function FillFormProvinces(data)
{       var select = document.getElementById("province");
        select.options.length = 0;
        var provinces = eval('(' + data.responseText + ')');
        for (var i = 0; i < provinces.length; i++){
            select.options[select.options.length] = new Option(provinces[i].name, provinces[i].province_id); 
        }
        
        loadCities(); 
}
</script>
<form method="<?php echo $form->getMethod() ?>" action="<?php echo $form->getAction()?>" enctype="multipart/form-data">
    <div align="center">
        <table width="100%">
            <tr>
                <td>
                    <div style="background-image: url(/images/backend/tit-busqueda.png); background-repeat:no-repeat; background-position: center; height: 50px;">&nbsp;</div>
                    <hr/>
                    <?php echo $this->errorMessage($this->form, $messages); ?>
                </td>
            </tr>
            <tr>
                <td><?php echo $form->province->renderViewHelper(); ?></td>
            </tr>
            <tr>
                <td><?php echo $form->city->renderViewHelper(); ?></td>
            </tr>
            <tr>
                <td align="center">
                    <div>
                        <table id="list2"></table>
                        <div id="pager2"></div>
                    </div>
                </td>
            </tr>
            <tr>
                <td align="center" height="75px">
                    <div>
                        <?php echo $form->search->renderViewHelper(); ?> 
                    </div>        
                </td>
            </tr>
        </table>
    </div>
</form>
<script type="text/javascript" src='/scripts/jquery-1.8.2.js'></script>
<script type="text/javascript" src='/scripts/jquery-ui-1.9.1.custom.js'></script>
<script type="text/javascript" src='/scripts/grid.locale-es.js'></script>
<script type="text/javascript" src='/scripts/jquery.jqGrid.min.js'></script>
<script type="text/javascript">

loadProvinces();

function getPromotions(){
    var city = document.getElementById('city').options[document.getElementById('city').selectedIndex].value;
    alert('city:'+city);
    jQuery("#list2").jqGrid({url:'http://promosalpaso.local/promotion/search/city/' + city, datatype: "json",
         colNames:['Imagen', 'Comercio','Titulo', 'Texto', 'Valor', 'Distancia'],
         colModel:[ {name:'Imagen',index:'img', width:50,sortable:false},
                    {name:'Comercio',index:'name', width:50}, 
                    {name:'Titulo',index:'displayed_text', width:50},
                    {name:'Texto',index:'short_description', width:50},
                    {name:'Valor',index:'promo_value', width:200},
                    {name:'Distancia',index:'distance', width:50},
         ],
         rowNum:10,
         rowList:[10,20,30],
         pager: '#pager2',
         sortname: 'starts',
         viewrecords: true,
         sortorder: "desc",
         mtype:"POST",
         caption:"Grilla de Promociones",
         gridComplete: function(){
            var ids = jQuery("#list2").jqGrid('getDataIDs');
            for(var i=0;i < ids.length;i++){
                var cl = ids[i];
                be = "<a href='/promotion/edit/id/"+cl+"'><span class='ui-icon ui-icon-pencil'></span></a>"; 
                se = "<a href='/promotion/delete/id/"+cl+"'><span class='ui-icon ui-icon-trash'></span></a>"; 
                jQuery("#list2").jqGrid('setRowData',ids[i],{act:be+se});
            }    
    },
     })
     jQuery("#list2").jqGrid('GridNav','#pager2',{edit:false,add:false,del:false});
    }
</script>