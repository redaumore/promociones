<?php
    $messages = $this->errorMessage;
    $this->form->setAction($this->url());
    $form = $this->form;
?>
<style type="text/css">
    select[multiple], select[size] {
        height: 310px;
    }
</style>
<script type="text/javascript" src="/scripts/prototype.js"></script>
<script type="text/javascript" src='/scripts/grid.locale-es.js'></script>
<script type="text/javascript" src='/scripts/jquery.jqGrid.min.js'></script>
<script type="text/javascript" src="/scripts/promosalpaso.js"></script>
<script type="text/javascript">
function loadCities()
{
        var selectedValue = document.getElementById('province').options[document.getElementById('province').selectedIndex].value;
        var myAjax = new Ajax.Request(
        "<?=$this->url(array('controller'=>'Backendajax','action'=>'getCities'),'default', true)?>",
            {
                method:'get',
                parameters: {province_id: selectedValue},
                onSuccess: FillForm,
                async: false
        });
        console.log("loadCities");
}

function loadProvinces()
{       var myAjax = new Ajax.Request(
        "<?=$this->url(array('controller'=>'Backendajax','action'=>'getprovinces'),'default', true)?>",
            {
                method:'get',
                onSuccess: FillFormProvinces,
                async: false
        });
        
 
}

function FillForm(data)
{       var select = document.getElementById("city");
        select.options.length = 0;
        var cities = eval('(' + data.responseText + ')');
        for (var i = 0; i < cities.length; i++){
            select.options[select.options.length] = new Option(cities[i].name, cities[i].city_id); 
        }
        console.log("FillForm"); 
        
        var city = jQuery('#reqcity').val();
        if(city != ''){
            jQuery('#city option[value='+ city +']').attr('selected',true);
        }
        
        var category = jQuery('#reqcategory').val();
        if(category != ''){
            jQuery("#category option[value='"+category+"']").attr("selected", "selected");    
            //TODO: Hacerlo para varias categorías
        }
        
        getPromotions();
}

function FillFormProvinces(data)
{       var select = document.getElementById("province");
        select.options.length = 0;
        var provinces = eval('(' + data.responseText + ')');
        for (var i = 0; i < provinces.length; i++){
            select.options[select.options.length] = new Option(provinces[i].name, provinces[i].province_id); 
        }
        console.log("FillFromProvinces");
        loadCities(); 
}
</script>
<form method="<?php echo $form->getMethod() ?>" action="<?php echo $form->getAction()?>" enctype="multipart/form-data">
    <div class="row-fluid">
        <div class="row">
            <div class="pagination-centered" id="titulo">
                <h1>Búsqueda de Promociones</h1>
            </div>
        </div>
        <hr class="hr-subtitle"/>
        <?php echo $this->errorMessage($this->form, $messages); ?>
    </div>
    <div class="row-fluid">
        <div class="span4">
            <div class="control-group">
                <?php echo $form->street->renderLabel(); ?>
                <div class="controls">
                    <?php echo $form->street->renderViewHelper(); ?>
                </div>
            </div>
        </div>
        <div class="span1" style="margin-left:0">
            <div class="control-group">
                <?php echo $form->number->renderLabel(); ?>
                <div class="controls">
                    <?php echo $form->number->renderViewHelper(); ?>
                </div>
            </div>
        </div>
        <div class="span3">
            <div class="control-group">
                <?php echo $form->province->renderLabel(); ?>
                <div class="controls">
                    <?php echo $form->province->renderViewHelper(); ?>
                </div>
            </div>
        </div>
        <div class="span3">
            <div class="control-group">
                <?php echo $form->city->renderLabel(); ?>
                <div class="controls">
                    <?php echo $form->city->renderViewHelper(); ?>
                </div>
            </div>
        </div>
        <div class="span1" style="margin-left:0">
            <div class="control-group">
                <div class="controls">&nbsp;
                    <?php echo $form->search->renderViewHelper(); ?>
                </div>
            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span3 well">
            <div class="row-fluid pagination-left">
                <div class="control-group">
                    <?php echo $form->category->renderLabel(); ?>
                    <div class="controls">
                        <?php echo $form->category->renderViewHelper(); ?>
                    </div>
                </div>
                <div class="control-label optional" style="font-size: 0.8em; color: #BCBCBC">Para seleccionar más de una categoría mantén la tecla "Ctrl" presionada.</div>
            </div>
        </div>
        <div class="span9 pagination-centered">
            <div class="row-fluid">
                <?php echo $this->partial("index/_alert.phtml"); ?>
                <div id="search_message"><br/><h3 id="text_search_message" class="info_message">Estas buscando.....</h3></div>
            </div>
            <div class="row-fluid">
                <table id="list2"></table>
                <div id="pager2"></div>    
            </div>
        </div>
    </div>
        <?php 
            echo $form->reqcity;
            echo $form->reqcategory;
         ?>
</form>
<script type="text/javascript">
var firstClick = true;
function getPromotions(){
    jQuery("#div_message").hide();
    var city = document.getElementById('city').options[document.getElementById('city').selectedIndex].value;
    var categories = document.getElementById('category').options;
    var categoriesString = address = categoriesNames = '';
    
    for (x=0; x<categories.length; x++){
      if(categories[x].selected){
        categoriesString += categories[x].value + ",";   
        categoriesNames += categories[x].text + ", ";
        categoriesNames = categoriesNames.replace('└─', '');  
      }
    }
    if(categoriesString != ''){
        categoriesString = '/categories/' + categoriesString.substring(0, categoriesString.length-1);
        categoriesNames = categoriesNames.substring(0, categoriesNames.length-2);
    }
    if (jQuery('#street').val() != '' && jQuery('#number').val()!=''){
        address = '/address/'+jQuery('#street').val()+'+'+jQuery('#number').val()    
    }
    jQuery("#text_search_message").html("Estas buscando "+(categoriesNames==''?'todas las categorías':categoriesNames)+" en "+jQuery("#city option:selected").text()+".");
    jQuery("#search_message").show();
    changeTitle(categoriesNames, jQuery("#city option:selected").text());
    
    var _url = _baseUri + '/promotion/search/city/' + city + categoriesString + address;
    if (!firstClick){
        jQuery('#list2').jqGrid('clearGridData');
        jQuery("#list2").jqGrid('setGridParam', { url: _url, datatype: "json" }).trigger("reloadGrid");
    }
    else{ 
        firstClick = false;
        jQuery("#gbox_list2").hide();
        jQuery("#list2").jqGrid({url: _url, datatype: "json",
             colNames:['Imagen', 'Comercio','Promoción', 'Dirección', 'Valor', ''],
             colModel:[ {name:'img',index:'path', width:54,sortable:false},
                        {name:'Comercio',index:'name', width:170}, 
                        {name:'Promoción',index:'displayed_text', width:230},
                        {name:'Dirección',index:'short_description', width:300},
                        {name:'value',index:'promo_value', width:45, align:'center'},
                        {name:'is_percentage',index:'is_percentage', hidden: true},
             ],
             //rowNum:20,
             rowList:[20,30,40],
             pager: '#pager2',
             sortname: 'starts',
             viewrecords: true,
             sortorder: "desc",
             sortable: true,
             height: "100%",
             mtype:"POST",
             caption:"Promociones encontradas",
             gridComplete: function(){
                 var ids = jQuery("#list2").jqGrid('getDataIDs');
                 if(ids.length == 0 ){
                     showMessage("info", "No se encontraron promos para los filtros de búsqueda seleccionados.");
                     jQuery("#search_message").hide();
                     jQuery("#gbox_list2").hide();
                     return;
                 }
                 else{
                     jQuery("#div_message").hide();
                     jQuery("#search_message").show();
                 }
                 for(var i=0;i < ids.length;i++){
                     var cl = ids[i];
                     var row = jQuery("#list2").jqGrid('getRowData',cl);
                     var val; 
                     be = "<img src='"+row["img"]+"' height='50px' width='50px' style='margin:2px'/>";
                     if(parseFloat(row["value"]) == -396)
                        val = "[N/A]"
                     else
                        val = (row["is_percentage"] == "1")?cutDecimals(row["value"])+"%":"$"+cutDecimals(row["value"]);
                     jQuery("#list2").jqGrid('setRowData',ids[i],{img:be,value:val});
                     jQuery("#"+cl).click(function(event){loadPromotion(jQuery(this).attr("id"));});
                 }
                 jQuery("#gbox_list2").show();
             },
        })
     //jQuery("#list2").trigger('reloadGrid');
     //jQuery("#list2").jqGrid('GridNav','#pager2',{edit:false,add:false,del:false});
    }
}

function loadPromotion(promotion_id){
    var myAjax = new Ajax.Request(
        "<?=$this->url(array('controller'=>'Backendajax','action'=>'getPromotion'),'default', true)?>",
            {
                method:'get',
                parameters: {promotion_id: promotion_id},
                onSuccess: callFillPromotion
        });    
}

jQuery(document).ready(function(){
    loadProvinces();
})


</script>
<?php echo $this->partial("promotion/_promobody.phtml"); ?>